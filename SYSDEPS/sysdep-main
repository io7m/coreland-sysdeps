#!/bin/sh

#
# this file is only ever called by modules, so all paths must be
# relative to the module ("../../").
#

# path from module to sysdeps dir (MUST end with trailing slash)
SYSDEP_DIR_RELATIVE="../../"
export SYSDEP_DIR_RELATIVE

# outdir is relative to each entry in modules directory, can be
SYSDEP_OUTDIR="${SYSDEP_DIR_RELATIVE}/../"

# override with conf-outdir if it exists
if [ -f "${SYSDEP_DIR_RELATIVE}/conf-outdir" ]
then
  DIR=`head -n 1 "${SYSDEP_DIR_RELATIVE}/conf-outdir"`
  if [ $? -eq 0 ]
  then
    SYSDEP_OUTDIR="${SYSDEP_DIR_RELATIVE}/${DIR}"
  fi
fi
export SYSDEP_OUTDIR

SYSDEP_TRY_CONFIG_BIN=${SYSDEP_DIR_RELATIVE}/sd-configbin
SYSDEP_TRY_PKG_CONFIG=${SYSDEP_DIR_RELATIVE}/sd-configpkg
SYSDEP_TRY_MANUAL=${SYSDEP_DIR_RELATIVE}/sd-configman
SYSDEP_FATAL=${SYSDEP_DIR_RELATIVE}/sd-fatal
SYSDEP_ERROR=${SYSDEP_DIR_RELATIVE}/sd-error
SYSDEP_INFO=${SYSDEP_DIR_RELATIVE}/sd-info
SYSDEP_FILE=${SYSDEP_DIR_RELATIVE}/sd-file
SYSDEP_LINE=${SYSDEP_DIR_RELATIVE}/sd-line

PWD=`pwd`
SYSDEP_MODULE="`basename $PWD`"

export SYSDEP_MODULE
export SYSDEP_TRY_CONFIG_BIN
export SYSDEP_TRY_PKG_CONFIG
export SYSDEP_TRY_MANUAL
export SYSDEP_ERROR
export SYSDEP_INFO
export SYSDEP_FATAL
export SYSDEP_FILE
export SYSDEP_LINE

# 'clean' scripts may set this variable to vastly speed up 'make clean'
if [ -z "${SYSDEP_CLEAN}" ];
then
  . ${SYSDEP_DIR_RELATIVE}/sysdep-subs;

  if [ -f CREATES ]
  then
    CREATES=`cat CREATES`
  fi
  if [ -f SYSDEPOUT ]
  then
    CREATES="${CREATES} sysdeps.out"
  fi
  if [ -x custom ]
  then
    ./custom ${CREATES}
  fi
  for file in ${CREATES}
  do
    if [ "${file}" = "sysdeps.out" ]
    then
      cat "$file" >> "${SYSDEP_OUTDIR}/$file"
      rm -f "${file}"
    else
      cp "$file" "${SYSDEP_OUTDIR}/$file"
      rm -f "${file}"
    fi
  done
else
  rm -f ${SYSDEP_DIR_RELATIVE}/sd-cpuidx86 \
        ${SYSDEP_DIR_RELATIVE}/sd-cpuidx86.o
  rm -f ${SYSDEP_DIR_RELATIVE}/sd-arch \
        ${SYSDEP_DIR_RELATIVE}/sd-arch.o
  rm -f ${SYSDEP_DIR_RELATIVE}/sd-cctype \
        ${SYSDEP_DIR_RELATIVE}/sd-cctype.o
  rm -f ${SYSDEP_DIR_RELATIVE}/sd-ccversion \
        ${SYSDEP_DIR_RELATIVE}/sd-ccversion.o
  rm -f ${SYSDEP_DIR_RELATIVE}/sd-os \
        ${SYSDEP_DIR_RELATIVE}/sd-os.o

  #
  # Clean up created files
  #

  if [ -f CREATES ]
  then
    for file in `cat CREATES`
    do
      rm -f "${file}" "${SYSDEP_OUTDIR}/${file}"
    done
  fi
fi
